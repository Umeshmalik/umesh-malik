# ============================================
# CI â€” Run Tests on Pull Requests
# ============================================

name: Test

on:
  pull_request:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'docs/**'
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'docs/**'

jobs:
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: blog_automation_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U testuser -d blog_automation_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql://testuser:testpass@localhost:5432/blog_automation_test?schema=public
      ANTHROPIC_API_KEY: sk-ant-test-key-for-ci-000000000000
      WEBSITE_API_URL: https://api.test.com
      WEBSITE_API_KEY: test-key
      WEBSITE_TYPE: custom
      PUBLISH_DRY_RUN: true
      NODE_ENV: test
      LOG_LEVEL: error

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: blog-automation/package-lock.json

      - name: Install dependencies
        working-directory: blog-automation
        run: npm ci

      - name: Generate Prisma client
        working-directory: blog-automation
        run: npx prisma generate

      - name: Run database migrations
        working-directory: blog-automation
        run: npx prisma migrate deploy

      - name: TypeScript type check
        working-directory: blog-automation
        run: npx tsc --noEmit

      - name: Run unit tests
        working-directory: blog-automation
        run: npx jest --coverage --testPathPatterns='src/services/__tests__' --forceExit

      - name: Run integration tests
        working-directory: blog-automation
        run: npx jest --testPathPatterns='tests/integration' --forceExit

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: blog-automation/coverage/
          retention-days: 7

      - name: Check coverage thresholds
        working-directory: blog-automation
        run: |
          npx jest --coverage --coverageReporters=text-summary --forceExit 2>&1 | tee coverage-summary.txt
          echo "Coverage report generated"
