name: Post-Deploy SEO Ping

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  wait-for-deploy:
    name: Wait for Cloudflare Pages
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Cloudflare Pages deploy
        run: |
          echo "Waiting 90s for Cloudflare Pages to complete deployment..."
          sleep 90

      - name: Verify sites are live
        run: |
          COM=$(curl -s -o /dev/null -w "%{http_code}" "https://umesh-malik.com")
          IN=$(curl -s -o /dev/null -w "%{http_code}" "https://umesh-malik.in")
          echo ".com → $COM"
          echo ".in  → $IN"
          if [ "$COM" != "200" ] && [ "$IN" != "200" ]; then
            echo "::warning::Both sites returned non-200 — deploy may still be in progress"
          fi

  websub-google:
    name: WebSub → Google
    needs: wait-for-deploy
    runs-on: ubuntu-latest
    steps:
      - name: Notify Google via PubSubHubbub
        run: |
          HUB="https://pubsubhubbub.appspot.com"
          for DOMAIN in "umesh-malik.com" "umesh-malik.in"; do
            for FEED in "/rss.xml" "/blog-feed.xml" "/feed.json"; do
              RESP=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$HUB" \
                -d "hub.mode=publish" \
                -d "hub.url=https://${DOMAIN}${FEED}")
              echo "${DOMAIN}${FEED} → HTTP $RESP"
            done
          done

  indexnow-bing:
    name: IndexNow → Bing/Yandex/DuckDuckGo
    needs: wait-for-deploy
    runs-on: ubuntu-latest
    steps:
      - name: Submit URLs to IndexNow
        run: |
          KEY="b52fd35b0ee3234d8074e58fa2591da9"

          for DOMAIN in "umesh-malik.com" "umesh-malik.in"; do
            BLOG_URLS=$(curl -sf "https://${DOMAIN}/blog-sitemap.xml" \
              | grep -o '<loc>[^<]*</loc>' \
              | sed 's/<[^>]*>//g' \
              | head -5 || echo "")

            URL_JSON="\"https://${DOMAIN}/\", \"https://${DOMAIN}/blog\""
            while IFS= read -r url; do
              [ -n "$url" ] && URL_JSON="${URL_JSON}, \"${url}\""
            done <<< "$BLOG_URLS"

            RESP=$(curl -s -o /dev/null -w "%{http_code}" -X POST "https://api.indexnow.org/indexnow" \
              -H "Content-Type: application/json" \
              -d "{
                \"host\": \"${DOMAIN}\",
                \"key\": \"${KEY}\",
                \"keyLocation\": \"https://${DOMAIN}/${KEY}.txt\",
                \"urlList\": [${URL_JSON}]
              }")
            echo "${DOMAIN} → HTTP $RESP"
          done

  summary:
    name: Summary
    needs: [websub-google, indexnow-bing]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Write summary
        run: |
          echo "## SEO Notification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Method | Engines | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| WebSub (PubSubHubbub) | Google | ${{ needs.websub-google.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| IndexNow | Bing, Yandex, DuckDuckGo, Seznam, Naver | ${{ needs.indexnow-bing.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**For fastest Google indexing:**" >> $GITHUB_STEP_SUMMARY
          echo "Google Search Console → URL Inspection → Request Indexing" >> $GITHUB_STEP_SUMMARY
