name: Deploy to Cloudflare

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci
      - run: npx tsc --noEmit

  deploy-staging:
    name: Deploy to Staging
    needs: typecheck
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: Run D1 migrations (staging)
        run: npx wrangler d1 migrations apply blog-automation-db --env staging

      - name: Deploy Worker (staging)
        run: npx wrangler deploy --env staging

      - name: Verify staging health
        run: |
          sleep 5
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://blog-automation-staging.${{ secrets.WORKERS_SUBDOMAIN }}.workers.dev/health" || echo "000")
          if [ "$STATUS" != "200" ]; then
            echo "WARNING: Health check returned $STATUS"
          else
            echo "Staging health check passed"
          fi

  deploy-production:
    name: Deploy to Production
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: Run D1 migrations
        run: npx wrangler d1 migrations apply blog-automation-db

      - name: Deploy Worker
        run: npx wrangler deploy

      - name: Verify production health
        run: |
          sleep 5
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://blog-automation.${{ secrets.WORKERS_SUBDOMAIN }}.workers.dev/health" || echo "000")
          if [ "$STATUS" != "200" ]; then
            echo "::warning::Health check returned $STATUS â€” verify manually"
          else
            echo "Production health check passed"
          fi

      - name: Notify Slack
        if: always()
        run: |
          STATUS="${{ job.status }}"
          EMOJI="âœ…"
          if [ "$STATUS" != "success" ]; then EMOJI="ðŸ”´"; fi
          
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -s -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H 'Content-Type: application/json' \
              -d "{\"text\": \"${EMOJI} Blog Automation deployment ${STATUS}\\nCommit: ${{ github.sha }}\\nBy: ${{ github.actor }}\"}"
          fi
